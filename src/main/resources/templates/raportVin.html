<!DOCTYPE html>
<html lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head}"><title>Car Health Check</title></head>
<script th:src="@{/js/autoUploadVinReport.js}"></script>
<body>
<div th:replace="~{layout :: navbar}"></div>
<div class="container py-4">
    <main>
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <h4 class="mb-3" th:text="#{raport.details}"></h4>
                <p class="mb-4">
                    <strong th:text="#{raport.vin}"></strong>
                    <span th:text="${car.vin}"></span>><br>

                    <strong th:text="#{raport.date}"></strong>
                    <span th:text="${car.firstRegistrationDate}"></span>
                </p>
            </div>
        </div>

        <div class="row justify-content-center mb-4">
            <div class="col-md-8">
                <div class="alert alert-info text-center p-4 rounded-3 shadow-sm">
                    <h5 class="mb-3" th:text="#{raport.site.label}"></h5>
                    <p class="mb-3" th:utext="#{raport.site.text}"></p>
                    <a href="https://historiapojazdu.gov.pl"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="btn btn-success btn-lg px-4 py-2 rounded-pill shadow-sm"
                       th:text="#{raport.site.button}">
                    </a>
                </div>
            </div>
        </div>

        <div class="row justify-content-center mb-3">
            <div class="col-md-6">
                <form th:action="@{/design/raportVin/upload(carId=${car.id})}"
                      method="post"
                      enctype="multipart/form-data"
                      class="text-center"
                      id="vinUploadForm">

                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <div class="mb-3">
                        <input type="file"
                               name="file"
                               accept="application/pdf"
                               class="form-control"
                               required
                               onchange="autoUploadVinReport()">
                    </div>

                    <div class="text-muted small">
                        <p th:text="#{raport.info}"></p>
                    </div>
                </form>
            </div>
        </div>
        <div th:if="${reportFile != null and #authorization.expression('hasRole(''ADMIN'')')}"
             class="alert alert-secondary mt-3">

            <div><b>
                <th:block th:text="#{raport.info.status} + ' '"/>
            </b>
                <span th:text="${reportFile.status}"></span></div>

            <div><b>
                <th:block th:text="#{raport.info.uploadedAt} + ' '"/>
            </b>
                <span th:text="${reportFile.uploadedAt}"></span></div>

            <div><b>
                <th:block th:text="#{raport.info.parsedAt} + ' '"/>
            </b>
                <span th:text="${reportFile.parsedAt}"></span></div>
        </div>
        <div th:if="${reportFile != null and reportFile.status.name() == 'PARSED_ERROR'}"
             class="alert alert-danger mt-3" th:text="#{raport.info.errorText}">
        </div>
        <div th:if="${reportFile != null and reportFile.status.name() == 'PARSED_OK' and vinData != null}"
             class="alert alert-info mt-3">
            <div><b>
                <th:block th:text="#{raport.info.data}"/>
            </b></div>
            <div>
                <th:block th:text="#{raport.info.filename} + ' '"/>
                <span th:text="${reportFile.originalFilename}"></span></div>
            <div>
                <th:block th:text="#{raport.info.data.production.year} + ' '"/>
                <span th:text="${vinData.productionYearFromReport}"></span></div>
            <div>
                <th:block th:text="#{raport.info.data.registration.year} + ' '"/>
                <span th:text="${vinData.firstRegistrationFromReport}"></span></div>
            <div>
                <th:block th:text="#{raport.info.data.registration.plateNumber} + ' '"/>
                <span th:text="${vinData.plateNumber}"></span></div>
            <div>
                <th:block th:text="#{raport.info.data.registration.registrationStatus} + ' '"/>
                <span th:text="${#messages.msg('registration.status.' + vinData.registrationStatus)}"></span></div>
            <div>
                <th:block th:text="#{raport.info.data.registration.ocStatus} + ' '"/>
                <span th:text="${#messages.msg('oc.status.' + vinData.ocStatus)}"></span></div>
            <div>
                <th:block th:text="#{raport.info.data.registration.technicalStatus} + ' '"/>
                <span th:text="${#messages.msg('inspection.status.' + vinData.technicalInspectionStatus)}"></span>
            </div>
            <div th:if="${vinData.ocValidUntil != null}">
                <th:block th:text="#{raport.info.data.registration.ocValidDate} + ' '"/>
                <span th:text="${vinData.ocValidUntil}"></span>
            </div>
            <div th:if="${vinData.lastOdometerKm != null}">
                <th:block th:text="#{raport.info.data.registration.lastOdometer} + ' '"/>
                <span th:text="${vinData.lastOdometerKm}"></span> km
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.theft} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.theft)}"></span>
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.scrapped} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.scrapped)}"></span>
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.accident} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.accident)}"></span>
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.damaged} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.damaged)}"></span>
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.odometerMismatch} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.odometerMismatch)}"></span>
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.notRoadworthy} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.notRoadworthy)}"></span>
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.taxi} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.taxi)}"></span>
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.totalLoss} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.totalLoss)}"></span>
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.vinChecksumError} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.vinChecksumError)}"></span>
            </div>
            <div>
                <th:block th:text="#{raport.info.data.risk.serviceActions} + ' '"/>
                <span th:text="${#messages.msg('car.risk.' + vinData.serviceActions)}"></span>
            </div>

        </div>
        <div th:if="${reportFile != null and reportFile.status.name() == 'PARSED_OK' and mileageEntries != null and !mileageEntries.isEmpty()}"
             class="card mt-3">
            <div class="card-body">
                <h6 class="card-title mb-3" th:text="#{raport.info.data.report.table.title}"></h6>

                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                        <tr>
                            <th th:text="#{raport.info.data.report.table.date}"></th>
                            <th th:text="#{raport.info.data.report.table.mileage}"></th>
                            <th th:text="#{raport.info.data.report.table.source}"></th>
                            <th th:text="#{raport.info.data.report.table.event}"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="e : ${mileageEntries}">
                            <td th:text="${e.readingDate}"></td>
                            <td th:text="${e.mileageKm}"></td>
                            <td th:text="#{${e.source}}"></td>
                            <td th:text="${e.eventTitle}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div th:if="${reportFile != null and reportFile.status.name() == 'PARSED_OK' and (mileageEntries == null or mileageEntries.isEmpty())}"
             class="alert alert-warning mt-3" th:text="#{raport.info.data.report.table.error}">
        </div>
        <div th:if="${reportFile != null and reportFile.status.name() == 'PARSED_ERROR' and reportFile.parseError != null and #authorization.expression('hasRole(''ADMIN'')')}"
             class="alert alert-secondary mt-2">
            <b>
                <th:block th:text="#{raport.info.data.errorText} + ' '"/>
            </b><span th:text="${reportFile.parseError}"></span>
        </div>
        <div class="row justify-content-center mt-4">
            <div class="col-md-6 text-center">
                <form method="post"
                      th:action="@{/design/raportVin(carId=${car.id})}">

                    <input type="hidden"
                           th:name="${_csrf.parameterName}"
                           th:value="${_csrf.token}"/>

                    <button type="submit"
                            class="btn btn-primary btn-lg px-4 py-2 rounded-pill shadow-sm"
                            th:text="#{design.button}">
                    </button>
                </form>

                <div th:insert="~{fragments/cancelButton.html}"
                     class="d-inline-block mt-2">
                </div>
            </div>
        </div>
    </main>
</div>
<div th:replace="~{layout :: footer}"></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>
</html>
